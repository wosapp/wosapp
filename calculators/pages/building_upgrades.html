<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Building Upgrades</title>
    <link rel="stylesheet" href="/style.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2112126597648781"
     crossorigin="anonymous"></script>

    <style>
        .building { margin-bottom: 20px; }
        .training-speed-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}
    </style>
</head>
<body>
    <header>
        <h1>Building Upgrades</h1>
        <p class="tagline">Calculate building upgrade cost and times</p>
    </header>
    <main>
    <div id="common-buttons"></div>
    <script>
      fetch('/utils/buttons.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('common-buttons').innerHTML = html;
        });
    </script>
        <p>
    Select buildings to manage their upgrade levels and input the building speed. 
    If president, vice president, double time and pet skill have not been activated 
    you can manually activate them.
    </p>

    <div id="buildings" class="tools-container" style="display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; margin-bottom: 32px;">
            <!-- Buildings will be rendered here -->
    </div>
    <div id="summary"></div>
    </main>
    
    <script>
const buildings = [
    "Furnace",
    "Embassy",
    "Command center",
    "Infirmary",
    "Infantry camp",
    "Lancer camp",
    "Marksman camp",
    "War academy"
];

// Track active/inactive state and levels for each building
const buildingStates = Array(buildings.length).fill(false);
const buildingLevels = Array(buildings.length).fill(null).map(() => ({ current: 1, target: 1 }));

function renderBuildings() {
    const container = document.getElementById('buildings');
    container.innerHTML = '';
    // 4 rows, 2 columns each
    for (let row = 0; row < 4; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.style.display = 'flex';
        rowDiv.style.gap = '24px';
        rowDiv.style.marginBottom = '16px';
        for (let col = 0; col < 2; col++) {
            const idx = row * 2 + col;
            if (idx >= buildings.length) break;
            const name = buildings[idx];
            const isActive = buildingStates[idx];
            const box = document.createElement('div');
            box.className = 'building-box';

            box.style.cursor = name !== "War academy" ? 'pointer' : 'default';

            if (name === "War academy") {
                box.innerHTML = `<span style="font-weight:bold; font-size:1.1em; color:#888;">War academy<br><span style="font-size:0.9em; color:#d32f2f;">(coming soon)</span></span>`;
            } else {
                box.innerHTML = `
                    <input type="checkbox" id="activate-${idx}" style="width:24px;height:24px;margin-right:12px;" ${isActive ? 'checked' : ''} tabindex="-1">
                    <label for="activate-${idx}" style="font-weight:bold; font-size:1.1em; cursor:pointer;">${name}</label>
                `;
                box.onclick = function(e) {
                    // Prevent double toggle if clicking directly on checkbox
                    if (e.target.tagName.toLowerCase() === 'input') return;
                    toggleBuilding(idx);
                };
            }
            rowDiv.appendChild(box);
        }
        container.appendChild(rowDiv);
    }
}

function toggleBuilding(idx) {
    buildingStates[idx] = !buildingStates[idx];
    renderBuildings();
    renderSummary();
}

function getLevelOptions(selected, minIdx = 0) {
    const levels = [];
    // Numeric levels 1-30
    for (let i = 1; i <= 30; i++) {
        levels.push(`<option value="${i}"${selected == i ? ' selected' : ''}${levelToIndex(i) < minIdx ? ' disabled' : ''}>${i}</option>`);
    }
    // 30.1 to 30.4
    for (let i = 1; i <= 4; i++) {
        const val = `30.${i}`;
        levels.push(`<option value="${val}"${selected == val ? ' selected' : ''}${levelToIndex(val) < minIdx ? ' disabled' : ''}>${val}</option>`);
    }
    // FC levels (FC1, FC1.1-FC1.4, ..., FC4, FC4.1-FC4.4, FC5 only)
    for (let fc = 1; fc <= 5; fc++) {
        const fcVal = `FC${fc}`;
        levels.push(`<option value="${fcVal}"${selected == fcVal ? ' selected' : ''}${levelToIndex(fcVal) < minIdx ? ' disabled' : ''}>${fcVal}</option>`);
        // Only add FCx.1-FCx.4 for FC1-FC4
        if (fc < 5) {
            for (let upg = 1; upg <= 4; upg++) {
                const val = `FC${fc}.${upg}`;
                levels.push(`<option value="${val}"${selected == val ? ' selected' : ''}${levelToIndex(val) < minIdx ? ' disabled' : ''}>${val}</option>`);
            }
        }
        // Do NOT add FC5.1-FC5.4
    }
    return levels.join('');
}

function levelToIndex(val) {
    if (/^FC\d+$/.test(val)) {
        // FC1 = 35, FC2 = 40, etc.
        return 34 + (parseInt(val.replace('FC', '')) - 1) * 5 + 1;
    }
    if (/^FC\d+\.\d+$/.test(val)) {
        // FC1.1 = 36, FC1.2 = 37, etc.
        const [fc, upg] = val.replace('FC', '').split('.');
        return 34 + (parseInt(fc) - 1) * 5 + parseInt(upg) + 1;
    }
    if (/^30\.\d+$/.test(val)) {
        // 30.1 = 31, 30.2 = 32, etc.
        return 30 + parseInt(val.split('.')[1]);
    }
    return parseInt(val); // 1-30
}

function renderSummary() {
    let summary = document.getElementById('summary');
    if (!summary) {
        summary = document.createElement('div');
        summary.id = 'summary';
        document.body.appendChild(summary);
    }
    const activeBuildings = buildings
        .map((name, idx) => ({ name, idx }))
        .filter(b => buildingStates[b.idx]);
    if (activeBuildings.length === 0) {
        summary.innerHTML = '';
        return;
    }
    summary.innerHTML = `
    <h2 style="margin-bottom:18px;">Selected Buildings</h2>
    <div class="tool-box summary-box">
        ${activeBuildings.length === 0 ? `<div style="color:#888;">No buildings selected.</div>` : `
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0 18px; align-items: center; width: 100%;">
                <div style="font-weight: 600; font-size: 1em; padding-bottom: 8px;">Building</div>
                <div style="font-weight: 600; font-size: 1em; padding-bottom: 8px;">From</div>
                <div style="font-weight: 600; font-size: 1em; padding-bottom: 8px;">To</div>
                ${activeBuildings.map(b => {
                    const cur = buildingLevels[b.idx].current;
                    const tar = buildingLevels[b.idx].target;
                    return `
                    <div style="padding:6px 0; font-weight:500; text-align:left; overflow-wrap:anywhere;">${b.name}</div>
                    <div style="padding:6px 0;">
                        <select onchange="setCurrentLevel(${b.idx}, this.value)" style="padding: 4px 8px; border-radius: 8px; border: 1px solid #ccc; min-width:80px; max-width:170px; width:100%;">
                            ${getLevelOptions(cur)}
                        </select>
                    </div>
                    <div style="padding:6px 0;">
                        <select onchange="setTargetLevel(${b.idx}, this.value)" style="padding: 4px 8px; border-radius: 8px; border: 1px solid #ccc; min-width:80px; max-width:170px; width:100%;">
                            ${getLevelOptions(tar, levelToIndex(cur))}
                        </select>
                    </div>
                    `;
                }).join('')}
            </div>
        `}
    </div>
    <section style="margin-top:32px;">
        <h2>Building Speed</h2>
        <div class="building-speed-row">
            <label for="trainingSpeed">Building speed (%): </label>
            <input type="number" id="trainingSpeed" min="0" max="1000" step="1" style="width:80px;">
        </div>
        <div class="building-speed-row" style="margin-top:16px;">
            <input type="checkbox" id="mercantilism" style="width:24px;height:24px;">
            <label for="mercantilism">Mercantilism (+10%)</label>
        </div>
        <div class="building-speed-row">
            <input type="checkbox" id="doubletime" style="width:24px;height:24px;">
            <label for="doubletime">Double time (+20%)</label>
        </div>
        <div class="building-speed-row">
            <input type="checkbox" id="vicePresident" style="width:24px;height:24px;">
            <label for="vicePresident">Vice president appointment (+10%)</label>
        </div>
        <div class="building-speed-row">
            <input type="checkbox" id="petSkill" style="width:24px;height:24px;" onchange="togglePetSkill()">
            <label for="petSkill">Pet skill</label>
            <select id="petSkillLevel" style="width:60px; display:none; margin-left:8px;">
                <option value="1">Lv.1</option>
                <option value="2">Lv.2</option>
                <option value="3">Lv.3</option>
                <option value="4">Lv.4</option>
                <option value="5">Lv.5</option>
            </select>
        </div>
        <div class="building-speed-row">
            <input type="checkbox" id="zinmanSkill" style="width:24px;height:24px;" onchange="toggleZinmanSkill()">
            <label for="zinmanSkill">Zinman skill</label>
            <select id="zinmanSkillLevel" style="width:60px; display:none; margin-left:8px;">
                <option value="1">Lv.1</option>
                <option value="2">Lv.2</option>
                <option value="3">Lv.3</option>
                <option value="4">Lv.4</option>
                <option value="5">Lv.5</option>
            </select>
        </div>
    </section>
    <div style="display: flex; justify-content: center; margin-top: 32px;">
        <button id="calculateBtn" style="
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 32px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        ">
            Calculate
        </button>
    </div>
`;
}

function togglePetSkill() {
    const petSkillChecked = document.getElementById('petSkill').checked;
    document.getElementById('petSkillLevel').style.display = petSkillChecked ? 'inline-block' : 'none';
}

function toggleZinmanSkill() {
    const zinmanChecked = document.getElementById('zinmanSkill').checked;
    document.getElementById('zinmanSkillLevel').style.display = zinmanChecked ? 'inline-block' : 'none';
}

function setCurrentLevel(idx, value) {
    buildingLevels[idx].current = value;
    const curIdx = levelToIndex(value);
    let tarIdx = levelToIndex(buildingLevels[idx].target);
    if (tarIdx <= curIdx) {
        // Find next available level value
        let options = [];
        // Build options array in same order as getLevelOptions
        for (let i = 1; i <= 30; i++) options.push(i);
        for (let i = 1; i <= 4; i++) options.push(`30.${i}`);
        for (let fc = 1; fc <= 5; fc++) {
            options.push(`FC${fc}`);
            if (fc < 5) for (let upg = 1; upg <= 4; upg++) options.push(`FC${fc}.${upg}`);
        }
        // Find index of current, set target to next if possible
        const idxInOptions = options.findIndex(opt => levelToIndex(opt) === curIdx);
        if (idxInOptions >= 0 && idxInOptions < options.length - 1) {
            buildingLevels[idx].target = options[idxInOptions + 1];
        } else {
            buildingLevels[idx].target = options[idxInOptions]; // fallback to current if at max
        }
    }
    renderSummary();
}

function setTargetLevel(idx, value) {
    buildingLevels[idx].target = value;
    renderSummary();
}

// Initial render
renderBuildings();
renderSummary();
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
function calculateUpgrades() {

    let totalMeat = 0, totalWood = 0, totalCoal = 0, totalIron = 0, totalFirecrystals = 0, totalTime = 0;
    let filesToLoad = 0, filesLoaded = 0;

    buildings.forEach((name, idx) => {
        if (!buildingStates[idx]) return;
        filesToLoad++;
        const filePath = `/data/${name.replace(/ /g, '_')}.csv`;
        const cur = buildingLevels[idx].current;
        const tar = buildingLevels[idx].target;
        const curIdx = levelToIndex(cur);
        const tarIdx = levelToIndex(tar);

        Papa.parse(filePath, {
            download: true,
            header: true,
            complete: function(results) {
                const data = results.data;
                data.forEach(row => {
                    const lvlIdx = levelToIndex(row.level);
                    if (lvlIdx > curIdx && lvlIdx <= tarIdx) {
                        totalMeat += Number(row.meat) || 0;
                        totalWood += Number(row.wood) || 0;
                        totalCoal += Number(row.coal) || 0;
                        totalIron += Number(row.iron) || 0;
                        totalFirecrystals += Number(row.firecrystals) || 0;
                        totalTime += Number(row.time) || 0;
                    }
                });
                filesLoaded++;
                if (filesLoaded === filesToLoad) {
                    // --- BUILDING SPEED BONUS ---
                    let speedBonus = Number(document.getElementById('trainingSpeed').value) || 0;
                    if (document.getElementById('mercantilism').checked) speedBonus += 10;
                    if (document.getElementById('doubletime').checked) speedBonus += 20;
                    if (document.getElementById('vicePresident').checked) speedBonus += 10;
                    if (document.getElementById('petSkill').checked) {
                        const petLevel = Number(document.getElementById('petSkillLevel').value);
                        if (petLevel === 1) speedBonus += 5;
                        else if (petLevel === 2) speedBonus += 7;
                        else if (petLevel === 3) speedBonus += 9;
                        else if (petLevel === 4) speedBonus += 12;
                        else if (petLevel === 5) speedBonus += 15;
                    }
                    // --- ZINMAN SKILL COST REDUCTION ---
                    let zinmanReduction = 0;
                    if (document.getElementById('zinmanSkill').checked) {
                        const zinmanLevel = Number(document.getElementById('zinmanSkillLevel').value);
                        if (zinmanLevel === 1) zinmanReduction = 0.03;
                        else if (zinmanLevel === 2) zinmanReduction = 0.06;
                        else if (zinmanLevel === 3) zinmanReduction = 0.09;
                        else if (zinmanLevel === 4) zinmanReduction = 0.12;
                        else if (zinmanLevel === 5) zinmanReduction = 0.15;
                    }
                    // Apply Zinman reduction to costs (not time)
                    totalMeat = Math.round(totalMeat * (1 - zinmanReduction));
                    totalWood = Math.round(totalWood * (1 - zinmanReduction));
                    totalCoal = Math.round(totalCoal * (1 - zinmanReduction));
                    totalIron = Math.round(totalIron * (1 - zinmanReduction));
                    totalFirecrystals = Math.round(totalFirecrystals);
                    // Calculate reduced time
                    const reduction = 1 / (1 + speedBonus / 100);
                    const finalTime = Math.round(totalTime * reduction);
                    showUpgradeResults(totalMeat, totalWood, totalCoal, totalIron, totalFirecrystals, finalTime, speedBonus);
                }
            }
        });
    });

    if (filesToLoad === 0) {
        showUpgradeResults(0,0,0,0,0,0,0);
    }
}

function formatNumberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function formatSecondsToDHMS(seconds) {
    seconds = Number(seconds);
    const d = Math.floor(seconds / (24 * 3600));
    seconds %= 24 * 3600;
    const h = Math.floor(seconds / 3600);
    seconds %= 3600;
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    // Pad minutes and seconds with leading zeros if < 10
    const mm = m < 10 ? `0${m}` : m;
    const ss = s < 10 ? `0${s}` : s;
    let result = "";
    if (d > 0) result += `${d}d `;
    if (h > 0 || d > 0) result += `${h}h:`;
    result += `${mm}m:${ss}s`;
    return result.trim();
}

function showUpgradeResults(meat, wood, coal, iron, firecrystals, time, speedBonus) {
    let resultDiv = document.getElementById('upgradeResults');
    if (!resultDiv) {
        resultDiv = document.createElement('div');
        resultDiv.id = 'upgradeResults';
        const calcBtnContainer = document.getElementById('calculateBtn').parentNode;
        calcBtnContainer.parentNode.insertBefore(resultDiv, calcBtnContainer.nextSibling);
    }
    resultDiv.innerHTML = `
        <div style="margin-top:24px; padding:16px; border-radius:12px; background:#374151; box-shadow:0 2px 8px rgba(0,0,0,0.04); max-width:400px; margin-left:auto; margin-right:auto;">
            <h3 style="color:#f9fafb;">Upgrade Results</h3>
            <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:8px;"><strong>Meat:</strong> ${formatNumberWithCommas(meat)}</li>
                <li style="margin-bottom:8px;"><strong>Wood:</strong> ${formatNumberWithCommas(wood)}</li>
                <li style="margin-bottom:8px;"><strong>Coal:</strong> ${formatNumberWithCommas(coal)}</li>
                <li style="margin-bottom:8px;"><strong>Iron:</strong> ${formatNumberWithCommas(iron)}</li>
                <li style="margin-bottom:8px;"><strong>Fire Crystals:</strong> ${formatNumberWithCommas(firecrystals)}</li>
                <li style="margin-bottom:8px;"><strong>Time:</strong> ${formatSecondsToDHMS(time)}</li>
                <li style="margin-bottom:8px;"><strong>Total Speed Bonus:</strong> ${speedBonus}%</li>
            </ul>
        </div>
    `;
}

// Attach to button
document.addEventListener('DOMContentLoaded', function() {
    document.body.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'calculateBtn') {
            calculateUpgrades();
        }
    });
});
</script>
</body>
<footer>
    <p class="footer-credits">
        <strong>Pollo #2612</strong> â€” Creator of Whiteout Survival Hub
    </p>
    <p class="disclaimer">
        This website, including its original guides, calculators, and code, is the intellectual property of the author.
    </p>
    <p class="disclaimer">
        Whiteout Survival Hub is an independent fan-made project and is not affiliated or associated with Whiteout Survival, Century Games and its developers.
    </p>
    <p class="disclaimer">
        All Whiteout Survival trademarks and content belong to their respective owners.
    </p>
</footer>
</html>